<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘» è¬è–ç¯€ç³–æœæŠ½çæ©Ÿ</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Bungee+Spice&display=swap" rel="stylesheet">
    <style>
        /* å®šç¾©å¯æ„›å¡é€šè¬è–ç¯€é¡è‰² */
        :root {
            --color-purple: #8b5cf6; /* ç´«è‰² */
            --color-orange: #f97316; /* äº®æ©˜è‰² */
            --color-mint: #6ee7b7; /* è–„è·ç¶  */
            --color-pink: #f472b6; /* ç²‰ç´… */
            --color-dark: #1f2937;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--color-dark);
            background-image: linear-gradient(135deg, var(--color-dark) 0%, #111827 100%);
        }
        .cute-title {
            font-family: 'Bungee Spice', cursive; /* ææ€ªå­—é«” */
            text-shadow: 3px 3px 0px var(--color-purple);
        }
        .draw-box {
            background: rgba(31, 41, 55, 0.8);
            backdrop-filter: blur(10px);
            border: 4px solid var(--color-mint);
            box-shadow: 0 0 40px rgba(100, 255, 100, 0.3);
            transition: all 0.3s ease;
        }
        .draw-button {
            transition: all 0.1s ease-in-out;
            box-shadow: 0 6px 0 var(--color-purple);
        }
        .draw-button:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 2px 0 var(--color-purple);
        }
        /* æŠ½çå‹•ç•«æ•ˆæœ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col justify-center items-center p-4">

    <!-- Firebase åˆå§‹åŒ–å€å¡Š -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug');
        
        let app = null;
        let db = null;
        let auth = null;
        let currentUserId = 'anonymous';

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // å…¨åŸŸè®Šæ•¸ä¾›æŠ½çé‚è¼¯ä½¿ç”¨
        window.db = null;
        window.currentUserId = null;
        window.appId = appId;

        if (firebaseConfig) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // èªè­‰ç™»å…¥
                const authenticate = async () => {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    currentUserId = auth.currentUser.uid;
                    window.db = db;
                    window.currentUserId = currentUserId;
                    console.log("Firebase: å·²ç™»å…¥ã€‚UserID:", currentUserId);
                    // ç™»å…¥å¾Œå•Ÿå‹•æŠ½çæ©Ÿæª¢æŸ¥
                    window.checkUserDrawStatus();
                };

                authenticate().catch(error => {
                    console.error("Firebase: èªè­‰å¤±æ•—ã€‚", error.message);
                    window.checkUserDrawStatus(); // å³ä½¿å¤±æ•—ä¹Ÿå˜—è©¦æª¢æŸ¥ï¼Œä½†åŠŸèƒ½å°‡å—é™
                });
            } catch (e) {
                console.error("Firebase: åˆå§‹åŒ–å¤±æ•—ã€‚", e);
            }
        } else {
            console.error("Firebase: ç¼ºå°‘è¨­å®šï¼Œç„¡æ³•åˆå§‹åŒ–ã€‚");
            window.checkUserDrawStatus(); // ç„¡æ³•ä½¿ç”¨ Firebase ä¹Ÿå•Ÿå‹•å‰ç«¯
        }

        // --- æŠ½çé‚è¼¯ (ä¾›å¤–éƒ¨èª¿ç”¨) ---

        // æŠ½ççµæœå„²å­˜è·¯å¾‘
        function getDrawDocRef() {
            if (!window.db || !window.currentUserId) return null;
            // ç§äººè³‡æ–™è·¯å¾‘: /artifacts/{appId}/users/{userId}/draw_results/user_draw
            return doc(db, 'artifacts', appId, 'users', currentUserId, 'draw_results', 'user_draw');
        }
        
        // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²æŠ½ç
        window.checkUserDrawStatus = async () => {
            const drawButton = document.getElementById('draw-button');
            const statusMessage = document.getElementById('draw-status-message');
            const docRef = getDrawDocRef();

            if (!docRef) {
                // å¦‚æœæ²’æœ‰ Firebase æˆ–æœªç™»å…¥ï¼Œé è¨­å…è¨±æŠ½çï¼Œä½†ç„¡æ³•æŒä¹…åŒ–
                drawButton.disabled = false;
                drawButton.innerHTML = 'é»æ“ŠæŠ½ç³–æœï¼ (æœªæŒä¹…åŒ–)';
                statusMessage.textContent = 'è«‹ç™»å…¥ä»¥ä¿å­˜æ‚¨çš„æŠ½ççµæœã€‚';
                return;
            }

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const result = docSnap.data();
                    drawButton.disabled = true;
                    drawButton.innerHTML = 'å·²æŠ½ç ğŸ¬';
                    statusMessage.textContent = `æ‚¨å·²ç¶“æŠ½éäº†ï¼ç²å¾—ï¼š${result.prize}ã€‚`;
                    document.getElementById('result-message').textContent = `æ‚¨ä¸Šæ¬¡æŠ½åˆ°çš„çå“æ˜¯ï¼š${result.prize}`;
                    document.getElementById('result-message').classList.remove('hidden');
                    console.log("ç”¨æˆ¶å·²æŠ½çï¼Œçµæœ:", result.prize);
                } else {
                    drawButton.disabled = false;
                    drawButton.innerHTML = 'é»æ“ŠæŠ½ç³–æœï¼';
                    statusMessage.textContent = 'æ¯å€‹å¸³è™Ÿé™æŠ½ä¸€æ¬¡ï¼ç¥æ‚¨å¥½é‹ï¼';
                }
            } catch (error) {
                console.error("æª¢æŸ¥æŠ½çç‹€æ…‹å¤±æ•—:", error);
                statusMessage.textContent = 'ç„¡æ³•æª¢æŸ¥æŠ½çç‹€æ…‹ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
                drawButton.disabled = true;
            }
        };

        // å„²å­˜æŠ½ççµæœ
        window.saveDrawResult = async (prize) => {
            const docRef = getDrawDocRef();
            if (!docRef) {
                console.warn("ç„¡æ³•ä¿å­˜çµæœï¼šFirebase æœªæº–å‚™å¥½ã€‚");
                return;
            }
            try {
                await setDoc(docRef, {
                    prize: prize,
                    timestamp: new Date(),
                }, { merge: true });
                console.log("æŠ½ççµæœå·²ä¿å­˜:", prize);
            } catch (error) {
                console.error("ä¿å­˜æŠ½ççµæœå¤±æ•—:", error);
            }
        };

        window.onload = () => {
             // ç¢ºä¿åœ¨è…³æœ¬è¼‰å…¥å¾Œï¼Œå¦‚æœ Firebase å°šæœªå°±ç·’ï¼Œä¹Ÿèƒ½é¡¯ç¤ºé è¨­ç‹€æ…‹
            if (!window.db) {
                window.checkUserDrawStatus();
            }
        };

    </script>


    <!-- ä¸»è¦å…§å®¹å€å¡Š -->
    <main class="w-full max-w-2xl mx-auto mt-12 mb-12">
        <header class="text-center mb-10">
            <h1 class="cute-title text-6xl sm:text-7xl md:text-8xl text-orange-400 mb-2 leading-none tracking-wider">
                Ghost Candy Bash
            </h1>
            <p class="text-2xl text-pink-400 font-bold">
                ğŸ‘» å¹½éˆç³–æœæ¨‚åœ’ - æŠ½çæ©Ÿ ğŸ¬
            </p>
        </header>

        <!-- æŠ½çæ©Ÿæ ¸å¿ƒå€å¡Š -->
        <section id="draw-machine" class="draw-box rounded-2xl p-6 sm:p-10 text-center mx-auto">
            
            <h2 class="text-3xl font-extrabold mb-6 text-mint-300">
                é»æ“ŠæŠ½ä¸€æ¬¡ï¼
            </h2>

            <!-- çµæœé¡¯ç¤ºæ¡† -->
            <div id="result-display" class="bg-gray-800 p-8 rounded-lg mb-8 h-32 flex justify-center items-center text-gray-100 text-3xl font-bold border-4 border-purple-500 overflow-hidden">
                <span id="prize-text">
                    æº–å‚™å¥½æ¥æ”¶æ‚¨çš„è¬è–ç¯€é©šå–œ...
                </span>
            </div>

            <!-- æŠ½çæŒ‰éˆ• -->
            <button id="draw-button" class="draw-button bg-orange-500 hover:bg-orange-400 text-gray-900 font-extrabold text-2xl py-4 px-10 rounded-xl uppercase tracking-wider transition duration-300" disabled>
                <span class="spinner inline-block mr-2 hidden">ğŸ”„</span> è¼‰å…¥ä¸­...
            </button>

            <!-- æŠ½çç‹€æ…‹è¨Šæ¯ -->
            <p id="draw-status-message" class="mt-4 text-sm text-gray-400 min-h-[20px]"></p>
            <p id="result-message" class="mt-4 text-lg text-pink-300 font-bold hidden">
                <!-- é¡¯ç¤ºä¸Šæ¬¡çµæœ -->
            </p>
            
            <div class="mt-6 text-left">
                <h3 class="text-xl font-bold text-mint-300 mb-2">çå“æ¸…å–®ï¼š</h3>
                <ul class="list-disc list-inside text-gray-300 text-sm grid grid-cols-2">
                    <li>ğŸƒ å‚‘å…‹å—ç“œç‹ (ç¨€æœ‰) - 1%</li>
                    <li>ğŸ¬ ç‰¹ç´šå¤ªå¦ƒç³– (æ™®é€š) - 25%</li>
                    <li>ğŸ­ ç”œèœœæ£’æ£’ç³– (æ™®é€š) - 25%</li>
                    <li>ğŸ•¸ï¸ èœ˜è››ç¶²è»Ÿç³– (æ™®é€š) - 20%</li>
                    <li>âœ¨ é–ƒäº®è²¼ç´™ (æ™®é€š) - 15%</li>
                    <li>â“ é©šåš‡ç©ºåŒ…å½ˆ (æ²’äº‹ç™¼ç”Ÿ) - 14%</li>
                </ul>
            </div>

        </section>

        <!-- ç¶²ç«™è£é£¾å€å¡Š -->
        <section class="mt-10 text-center">
            <p class="text-xl text-purple-400 font-semibold">
                ç¥æ‚¨æœ‰å€‹è©­ç•°åˆç”œèœœçš„å¤œæ™šï¼
            </p>
        </section>

    </main>

    <!-- é è…³ -->
    <footer class="text-center py-4 text-gray-500 text-sm">
        <p>ç”± VIBE CODING é©…å‹• | è¬è–ç¯€å¿«æ¨‚ï¼</p>
    </footer>

    <!-- JavaScript æŠ½çæ ¸å¿ƒé‚è¼¯ -->
    <script>
        const PRIZES = [
            { name: "ğŸƒ å‚‘å…‹å—ç“œç‹", weight: 1, color: 'text-red-500' }, // ç¨€æœ‰
            { name: "ğŸ¬ ç‰¹ç´šå¤ªå¦ƒç³–", weight: 25, color: 'text-orange-400' },
            { name: "ğŸ­ ç”œèœœæ£’æ£’ç³–", weight: 25, color: 'text-pink-400' },
            { name: "ğŸ•¸ï¸ èœ˜è››ç¶²è»Ÿç³–", weight: 20, color: 'text-mint-300' },
            { name: "âœ¨ é–ƒäº®è²¼ç´™", weight: 15, color: 'text-yellow-300' },
            { name: "â“ é©šåš‡ç©ºåŒ…å½ˆ", weight: 14, color: 'text-gray-400' }, // æ²’äº‹ç™¼ç”Ÿ
        ];

        function selectPrize() {
            let totalWeight = PRIZES.reduce((sum, item) => sum + item.weight, 0);
            let random = Math.random() * totalWeight;

            for (const prize of PRIZES) {
                if (random < prize.weight) {
                    return prize;
                }
                random -= prize.weight;
            }
            // é é˜²æ€§å›å‚³ (æ‡‰ä¸ç™¼ç”Ÿ)
            return PRIZES[PRIZES.length - 1]; 
        }

        const drawButton = document.getElementById('draw-button');
        const prizeText = document.getElementById('prize-text');
        const spinner = document.querySelector('.spinner');

        drawButton.addEventListener('click', async () => {
            if (drawButton.disabled) return;

            // 1. æŠ½çé–‹å§‹ç‹€æ…‹
            drawButton.disabled = true;
            spinner.classList.remove('hidden');
            prizeText.textContent = 'æŠ½çä¸­... ç·Šå¼µå—ï¼Ÿ';
            prizeText.className = 'transition-colors duration-500';
            
            // 2. æ¨¡æ“¬æŠ½çå‹•ç•«
            const intervalDuration = 50; // ms
            let cycle = 0;
            const tempPrizes = ['ğŸ¬', 'ğŸ­', 'ğŸ•¸ï¸', 'âœ¨', 'ğŸ‘»'];

            const spinningInterval = setInterval(() => {
                const tempPrize = tempPrizes[cycle % tempPrizes.length];
                prizeText.textContent = tempPrize + ' ' + tempPrize + ' ' + tempPrize;
                cycle++;
            }, intervalDuration);


            // 3. å»¶é²å¾Œå–å¾—çµæœ
            await new Promise(resolve => setTimeout(resolve, 3000)); // 3ç§’å‹•ç•«

            clearInterval(spinningInterval);
            spinner.classList.add('hidden');

            const selected = selectPrize();
            
            // 4. é¡¯ç¤ºçµæœ
            prizeText.textContent = `æ­å–œæ‚¨ç²å¾—ï¼š${selected.name}ï¼`;
            prizeText.classList.add(selected.color);
            drawButton.innerHTML = 'å·²æŠ½å‡ºï¼';
            
            // 5. å„²å­˜çµæœä¸¦æ›´æ–°ç‹€æ…‹
            if (window.db && window.currentUserId) {
                await window.saveDrawResult(selected.name);
                window.checkUserDrawStatus(); // å†æ¬¡æª¢æŸ¥ç‹€æ…‹ä»¥ç¢ºä¿æŒ‰éˆ•æ°¸ä¹…ç¦ç”¨
            } else {
                 // ç„¡æ³•æŒä¹…åŒ–ï¼Œä½†å‰ç«¯ä»ç¦ç”¨
                document.getElementById('draw-status-message').textContent = 'æŠ½çæˆåŠŸï¼Œä½†å› æœªé€£æ¥ Firebaseï¼Œæ‚¨çš„çµæœä¸æœƒè¢«ä¿å­˜ã€‚';
            }
        });
        
    </script>
</body>
</html>
